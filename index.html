<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menu</title>
  <meta name="theme-color" content="#0b0d10" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles.css" />

  <!-- Fix image cropping + layering so the button is clickable -->
  <style>
    /* Keep BG and scrim behind everything and non-interactive */
    .bg, .scrim {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    /* Ensure main content is above scrim */
    .header, .filters, .grid, .lightbox, .sheet {
      position: relative;
      z-index: 1;
    }

    /* Make product images true squares and well-cropped */
    .card-img {
      width: 80px;         /* adjust to 64/72/96px if you prefer */
      aspect-ratio: 1 / 1; /* guarantees a square */
      object-fit: cover;   /* fills the square without distortion */
      border-radius: 8px;
      display: block;
    }

    /* Ensure the orange FAB is always clickable above UI */
    .fab {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      z-index: 1000;       /* above everything */
    }

    /* Optional: make each product row align nicely */
    .card {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .card-content {
      flex: 1;
      min-width: 0;
    }
    .card-content h3 {
      margin: 0 0 4px;
    }
    .card-content p {
      margin: 0 0 6px;
    }
  </style>
</head>
<body>
  <!-- BACKGROUND -->
  <div class="bg"></div>
  <div class="scrim"></div>

  <!-- Header centré -->
  <header class="header">
    <img class="hero-logo" src="assets/logo.png" alt="logo" />
    <h1 class="hero-title">Menu</h1>
  </header>

  <!-- Filtres -->
  <section class="filters">
    <button class="chip" id="chipCategory">
      <span id="labelCategory">Toutes les catégories</span><span class="chev">▾</span>
    </button>
    <button class="chip" id="chipFarm">
      <span id="labelFarm">Toutes les farms</span><span class="chev">▾</span>
    </button>
  </section>

  <!-- Grille produits -->
  <main class="grid" id="grid" aria-live="polite"></main>

  <!-- Bouton panier / checkout -->
  <button id="checkoutBtn" class="fab" disabled>Envoyer la commande — 0,00€</button>

  <!-- Lightbox galerie -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <button class="lb-close" id="lbClose" aria-label="Fermer">✕</button>
    <button class="lb-prev" id="lbPrev" aria-label="Précédent">‹</button>
    <button class="lb-next" id="lbNext" aria-label="Suivant">›</button>
    <div class="lb-stage" id="lbStage"></div>
    <div class="lb-ind" id="lbInd"></div>
  </div>

  <!-- Sheet checkout -->
  <div id="sheet" class="sheet" aria-hidden="true">
    <div class="sheet-card">
      <header class="sheet-head">
        <h3>Finaliser la commande</h3>
        <button id="sheetClose" class="x">✕</button>
      </header>
      <div class="sheet-body">
        <h4>Produits sélectionnés :</h4>
        <ul id="cartList"></ul>

        <label>Nom / Prénom
          <input id="name" placeholder="Ton nom" autocomplete="name" />
        </label>
        <label>Téléphone
          <input id="phone" placeholder="+33..." inputmode="tel" autocomplete="tel" />
        </label>
        <label>Adresse complète
          <textarea id="address" rows="3" placeholder="N°, rue, code postal, ville"></textarea>
        </label>
        <div id="sheetError" class="error" role="alert" aria-live="polite"></div>
      </div>
      <footer class="sheet-foot">
        <div id="sheetTotal" class="sheet-total">Total : 0,00€</div>
        <button id="sendOrder" class="btn-primary">Envoyer la commande</button>
      </footer>
    </div>
  </div>

  <script type="module" src="app.js"></script>

  <!-- Minimal JS to load products, handle cart, open sheet, and send via sendOrder -->
  <script>
    const cart = [];

    async function loadProducts() {
      try {
        const res = await fetch("/.netlify/functions/listProducts");
        const data = await res.json();
        if (!data.ok) throw new Error(data.error?.message || "Erreur liste produits");

        const grid = document.getElementById("grid");
        grid.innerHTML = data.products.map(p => `
          <div class="card">
            <img src="${p.image}" alt="${p.title}" class="card-img" />
            <div class="card-content">
              <h3>${p.title}</h3>
              <p>${p.description || ""}</p>
              <strong>${p.price}€</strong>
            </div>
            <button class="btn-add" data-slug="${p.slug}" data-title="${p.title}" data-price="${p.price}">
              Ajouter
            </button>
          </div>
        `).join("");

        document.querySelectorAll(".btn-add").forEach(btn => {
          btn.addEventListener("click", () => {
            const slug = btn.dataset.slug;
            const title = btn.dataset.title;
            const price = parseFloat(btn.dataset.price);
            cart.push({ slug, title, price });
            updateCart();
          });
        });
      } catch (e) {
        console.error(e);
      }
    }

    function updateCart() {
      const total = cart.reduce((sum, item) => sum + item.price, 0);
      const btn = document.getElementById("checkoutBtn");
      btn.textContent = `Envoyer la commande — ${total.toFixed(2)}€`;
      btn.disabled = cart.length === 0;

      document.getElementById("sheetTotal").textContent = `Total : ${total.toFixed(2)}€`;
      document.getElementById("cartList").innerHTML = cart.map(p => `<li>${p.title} — ${p.price}€</li>`).join("");
    }

    // Open/close sheet
    document.getElementById("checkoutBtn").addEventListener("click", () => {
      document.getElementById("sheet").setAttribute("aria-hidden", "false");
    });
    document.getElementById("sheetClose").addEventListener("click", () => {
      document.getElementById("sheet").setAttribute("aria-hidden", "true");
    });

    // Send via Netlify function sendOrder
    document.getElementById("sendOrder").addEventListener("click", async () => {
      const tg = window.Telegram?.WebApp;
      const id = tg?.initDataUnsafe?.user?.id || null;
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();

      if (!id || !name || !phone || !address || cart.length === 0) {
        document.getElementById("sheetError").textContent = "Remplis tous les champs et ajoute au moins un produit.";
        return;
      }

      const order = { id, name, phone, address, cart };

      try {
        const res = await fetch("/.netlify/functions/sendOrder", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(order)
        });
        const data = await res.json();
        if (data.ok) {
          alert("Commande envoyée !");
          cart.length = 0;
          updateCart();
          document.getElementById("sheet").setAttribute("aria-hidden", "true");
        } else {
          document.getElementById("sheetError").textContent = "Erreur: " + (data.error?.message || "Envoi échoué");
        }
      } catch (err) {
        document.getElementById("sheetError").textContent = "Erreur envoi commande : " + err.message;
      }
    });

    loadProducts();
  </script>
</body>
</html>
